{"cells":[{"source":"<a href=\"https://www.kaggle.com/code/guywaffo/neural-bood-pressure-estimation?scriptVersionId=104108311\" target=\"_blank\"><img align=\"left\" alt=\"Kaggle\" title=\"Open in Kaggle\" src=\"https://kaggle.com/static/images/open-in-kaggle.svg\"></a>","metadata":{},"cell_type":"markdown","outputs":[],"execution_count":0},{"cell_type":"markdown","id":"8a16c3ae","metadata":{"papermill":{"duration":0.004121,"end_time":"2022-08-24T15:09:59.711657","exception":false,"start_time":"2022-08-24T15:09:59.707536","status":"completed"},"pycharm":{"name":"#%% md\n"},"tags":[]},"source":["## Network"]},{"cell_type":"code","execution_count":1,"id":"96dcb223","metadata":{"execution":{"iopub.execute_input":"2022-08-24T15:09:59.720138Z","iopub.status.busy":"2022-08-24T15:09:59.719566Z","iopub.status.idle":"2022-08-24T15:09:59.730125Z","shell.execute_reply":"2022-08-24T15:09:59.729122Z"},"papermill":{"duration":0.017401,"end_time":"2022-08-24T15:09:59.732285","exception":false,"start_time":"2022-08-24T15:09:59.714884","status":"completed"},"tags":[]},"outputs":[],"source":["import os\n"]},{"cell_type":"code","execution_count":2,"id":"c16e8fa3","metadata":{"collapsed":false,"execution":{"iopub.execute_input":"2022-08-24T15:09:59.74025Z","iopub.status.busy":"2022-08-24T15:09:59.73951Z","iopub.status.idle":"2022-08-24T15:10:05.792654Z","shell.execute_reply":"2022-08-24T15:10:05.791679Z"},"jupyter":{"outputs_hidden":false},"papermill":{"duration":6.059733,"end_time":"2022-08-24T15:10:05.795044","exception":false,"start_time":"2022-08-24T15:09:59.735311","status":"completed"},"pycharm":{"name":"#%%\n"},"tags":[]},"outputs":[],"source":["# Inspiration from AlexNet CNNF\n","'''The network consists of 5 Convolutional (CONV) layers and 3 Fully Connected (FC) layers.\n","The activation used is the Rectified Linear Unit (ReLU).\n","params:\n","data_in-shape : Tensor containing the ppg time series. Size (batch_size, ppg_length, 1) batch_size=128\n","fs : sampling frequency (default fs = 125 Hz)\n","'''\n","#Import libraries\n","import tensorflow as tf\n","from keras.layers import Reshape\n","from tensorflow.keras.layers import Softmax,Bidirectional,LSTM, Permute, Input, Add, Conv1D, MaxPooling1D, Dense, Activation, ZeroPadding2D, BatchNormalization, Flatten, Conv2D, AveragePooling1D, MaxPooling2D, GlobalMaxPooling2D, LeakyReLU, GlobalAveragePooling2D, ReLU, Dropout\n","from tensorflow.keras.initializers import glorot_uniform\n","from tensorflow.keras.models import Model\n","\n","\n","def AlexNet_1D(data_in_shape, num_output=2, dil=1, kernel_size=3, fs = 125, useMaxPooling=True, UseDerivative=False):\n","\n","    # Define the input as a tensor with shape input_shape\n","    X_input = Input(shape=data_in_shape)\n","\n","    if UseDerivative:\n","        dt1 = (X_input[:,1:] - X_input[:,:-1])*fs\n","        dt2 = (dt1[:,1:] - dt1[:,:-1])*fs\n","\n","        dt1 = tf.pad(dt1, tf.constant([[0,0],[0,1],[0,0]]))\n","        dt2 = tf.pad(dt2, tf.constant([[0,0],[0,2],[0,0]]))\n","        X = tf.concat([X_input, dt1, dt2], axis=2)\n","    else:        # X=tf.keras.layers.Concatenate(axis=2)([X_input, dt1,dt2])\n","        X=X_input\n","\n","    # convolutional stage\n","    X = Conv1D(filters=2, kernel_size=350, strides=1, name='conv1', kernel_initializer=glorot_uniform(seed=0), padding=\"same\")(X)\n","    X = Activation(ReLU())(X)\n","    X = BatchNormalization(axis=-1, name='BatchNorm1')(X)\n","    X = MaxPooling1D(175, strides=1, name=\"MaxPool1\",padding=\"same\")(X)\n","    \n","\n","    X = Conv1D(filters=10, kernel_size=175, strides=1, name='conv2', kernel_initializer=glorot_uniform(seed=0), padding=\"same\")(X)\n","    X = Activation(ReLU())(X)\n","    X = BatchNormalization(axis=-1, name='BatchNorm2')(X)\n","    X = MaxPooling1D(25, strides=1, name=\"MaxPool2\",padding=\"same\")(X)\n","\n","    X = Conv1D(filters=20, kernel_size=25, strides=1, name='conv3', kernel_initializer=glorot_uniform(seed=0), padding=\"same\")(X)\n","    X = Activation(ReLU())(X)\n","    X = BatchNormalization(axis=-1, name='BatchNorm3')(X)\n","    X = MaxPooling1D(10, strides=1, name=\"Maxpool3\",padding=\"same\")(X)\n","\n","    X = Conv1D(filters=40, kernel_size=10, strides=1, name='conv4', kernel_initializer=glorot_uniform(seed=0), padding=\"same\")(X)\n","    X = Activation(ReLU())(X)\n","    X = BatchNormalization(axis=-1, name='BatchNorm4')(X)\n","    X = MaxPooling1D(5, strides=1, name=\"Maxpool4\",padding=\"same\")(X)\n","\n","\n","    #Flattening the output of the NN\n","    X= Flatten()(X)\n","    X= Reshape((700,40))(X)\n","    #Bi-LSTM stage\n","    X = Bidirectional(LSTM(128, return_sequences=True),merge_mode='concat')(X)\n","    X = Bidirectional(LSTM(350, return_sequences=True),merge_mode='concat')(X)\n","\n","    # Fully connected slayer\n","    X = Flatten()(X)\n","    X = Dense( 2, activation='relu', name='dense', kernel_initializer=glorot_uniform(seed=0))(X)\n","\n","\n","\n","    # output stage\n","    X_SBP = Dense(1, activation='relu', name='SBP', kernel_initializer=glorot_uniform(seed=0))(X)\n","    X_DBP = Dense(1, activation='relu', name='DBP', kernel_initializer=glorot_uniform(seed=0))(X)\n","    model = Model(inputs=X_input, outputs=[X_SBP, X_DBP], name='AlexNet_1D')\n","    return model"]},{"cell_type":"code","execution_count":null,"id":"d445d286","metadata":{"papermill":{"duration":0.002887,"end_time":"2022-08-24T15:10:05.801159","exception":false,"start_time":"2022-08-24T15:10:05.798272","status":"completed"},"tags":[]},"outputs":[],"source":[]},{"cell_type":"markdown","id":"f3a052a2","metadata":{"papermill":{"duration":0.002666,"end_time":"2022-08-24T15:10:05.806777","exception":false,"start_time":"2022-08-24T15:10:05.804111","status":"completed"},"pycharm":{"name":"#%% md\n"},"tags":[]},"source":["## Training\n"]},{"cell_type":"code","execution_count":3,"id":"f4c1056b","metadata":{"execution":{"iopub.execute_input":"2022-08-24T15:10:05.814577Z","iopub.status.busy":"2022-08-24T15:10:05.813703Z","iopub.status.idle":"2022-08-24T15:10:05.819165Z","shell.execute_reply":"2022-08-24T15:10:05.818295Z"},"papermill":{"duration":0.011532,"end_time":"2022-08-24T15:10:05.821199","exception":false,"start_time":"2022-08-24T15:10:05.809667","status":"completed"},"tags":[]},"outputs":[],"source":["\n","CHECKPOINTS_FILE=\"/kaggle/input/outputstrainingphase2/logs/checkpoints/2022-22-08_alexnet_training_kaggle_cb.h5\""]},{"cell_type":"code","execution_count":4,"id":"b69726aa","metadata":{"collapsed":false,"execution":{"iopub.execute_input":"2022-08-24T15:10:05.828758Z","iopub.status.busy":"2022-08-24T15:10:05.82845Z","iopub.status.idle":"2022-08-24T15:10:06.043617Z","shell.execute_reply":"2022-08-24T15:10:06.042637Z"},"jupyter":{"outputs_hidden":false},"papermill":{"duration":0.22255,"end_time":"2022-08-24T15:10:06.046701","exception":false,"start_time":"2022-08-24T15:10:05.824151","status":"completed"},"pycharm":{"name":"#%%\n"},"tags":[]},"outputs":[{"name":"stderr","output_type":"stream","text":["2022-08-24 15:10:05.918978: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:937] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero\n","2022-08-24 15:10:06.032210: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:937] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero\n","2022-08-24 15:10:06.033027: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:937] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero\n"]}],"source":["\"\"\" train neural architectures using PPG data\n","\n","This script trains a neural network using PPG data. The data is loaded from the the .tfrecord files created by the script\n","'hdf_to_tfrecord.py'.\n","\"\"\"\n","import csv\n","import os.path\n","import warnings\n","from os.path import expanduser, join\n","from os import environ\n","from sys import argv\n","from functools import partial\n","from datetime import datetime\n","import argparse\n","\n","import tensorflow as tf\n","# tf.compat.v1.disable_eager_execution()\n","\n","\n","import pandas as pd\n","import numpy as np\n","import glob\n","\n","from tqdm import tqdm\n","\n","\n","gpu_devices = tf.config.experimental.list_physical_devices(\"GPU\")\n","for device in gpu_devices:\n","    tf.config.experimental.set_memory_growth(device, True)\n","\n","BATCH_SIZE=128\n","WIN_LEN=700\n","def read_tfrecord(example, win_len=WIN_LEN):\n","    tfrecord_format = (\n","        {\n","            'ppg': tf.io.FixedLenFeature([win_len], tf.float32),\n","            'label': tf.io.FixedLenFeature([2], tf.float32)\n","        }\n","    )\n","    parsed_features = tf.io.parse_single_example(example, tfrecord_format)\n","\n","    return parsed_features['ppg'], (parsed_features['label'][0], parsed_features['label'][1])\n","\n","\n","def create_dataset(tfrecords_dir, tfrecord_basename, win_len=WIN_LEN, batch_size=BATCH_SIZE, modus='train'):\n","    # pattern = join(tfrecords_dir, modus, tfrecord_basename + \"_\" + modus + \"_?????_of_?????.tfrecord\")\n","    pattern = glob.glob(tfrecords_dir + f\"/{modus}/*.tfrecord\")\n","    dataset = tf.data.TFRecordDataset.from_tensor_slices(pattern)\n","\n","    if modus == 'train':\n","        dataset = dataset.shuffle(1000, reshuffle_each_iteration=True)\n","        dataset = dataset.interleave(\n","            tf.data.TFRecordDataset,\n","            cycle_length=800,\n","            block_length=400)\n","    else:\n","        dataset = dataset.interleave(\n","            tf.data.TFRecordDataset)\n","\n","    dataset = dataset.map(partial(read_tfrecord, win_len=win_len), num_parallel_calls=2)\n","    dataset = dataset.shuffle(4096, reshuffle_each_iteration=True)\n","    dataset = dataset.prefetch(buffer_size=tf.data.AUTOTUNE)\n","    dataset = dataset.batch(batch_size, drop_remainder=False)\n","    dataset = dataset.repeat()\n","    \n","    return dataset\n","\n","\n","def get_model(architecture, input_shape, UseDerivative=False):\n","    return {\n","        'alexnet': AlexNet_1D(input_shape, UseDerivative=UseDerivative),\n","    }[architecture]\n","\n","DATASET_SIZE=51000\n","def ppg_train_mimic_iii(architecture,\n","                        DataDir,\n","                        ResultsDir,\n","                        CheckpointDir,\n","                        tensorboard_tag,\n","                        tfrecord_basename,\n","                        experiment_name,\n","                        win_len=WIN_LEN,\n","                        batch_size=BATCH_SIZE,\n","                        lr=None,\n","                        N_epochs=20,\n","                        Ntrain=round(DATASET_SIZE*0.7),\n","                        Nval=round(DATASET_SIZE*0.15),\n","                        Ntest=round(DATASET_SIZE*0.15),\n","                        UseDerivative=False,\n","                        earlystopping=False):\n","    # create datasets for training, validation and testing using .tfrecord files\n","    test_dataset = create_dataset(DataDir, tfrecord_basename, win_len=win_len, batch_size=batch_size,\n","                                  modus='test')\n","    train_dataset = create_dataset(DataDir, tfrecord_basename, win_len=win_len, batch_size=batch_size, modus='train')\n","    val_dataset = create_dataset(DataDir, tfrecord_basename, win_len=win_len, batch_size=batch_size,\n","                                 modus='val')\n","    data_in_shape = (win_len, 1)\n","\n","    # load the neurarchitecture\n","    model = get_model(architecture, data_in_shape, UseDerivative=UseDerivative)\n","\n","    # callback for logging training and validation results\n","    csvLogger_cb = tf.keras.callbacks.CSVLogger(\n","        filename=join(ResultsDir, experiment_name + '_learningcurve.csv')\n","    )\n","\n","    # checkpoint callback\n","    cb_file=join(CheckpointDir, experiment_name + '_cb.h5')\n","    checkpoint_cb = tf.keras.callbacks.ModelCheckpoint(\n","        filepath=cb_file,\n","        save_best_only=True\n","    )\n","    \n","    if os.path.exists(CHECKPOINTS_FILE):\n","        model.load_weights(CHECKPOINTS_FILE)\n","        print(\"Loaded weights from checkpoint\",CHECKPOINTS_FILE)\n","\n","    # tensorboard callback\n","    tensorbard_cb = tf.keras.callbacks.TensorBoard(\n","        log_dir=join(ResultsDir, 'tb', tensorboard_tag),\n","        histogram_freq=0,\n","        update_freq=\"batch\",\n","        write_images=True,\n","        write_graph=True    )\n","\n","    # callback for early stopping if validation loss stops improving\n","    EarlyStopping_cb = tf.keras.callbacks.EarlyStopping(\n","        monitor='val_loss',\n","        patience=10,\n","        restore_best_weights=True\n","    )\n","\n","\n","    # define Adam optimizer\n","    if lr is None:\n","        opt = tf.keras.optimizers.Adam()\n","    else:\n","        opt = tf.keras.optimizers.Adam(learning_rate=lr)\n","\n","    # compile model using mean squared error as loss function\n","    model.compile(\n","        optimizer=opt,\n","        loss=tf.keras.losses.mean_squared_error,\n","        metrics=[['mae','mse'], ['mae','mse']]\n","    )\n","    \n","    class LRA(tf.keras.callbacks.Callback):\n","        def __init__(self, model, initial_learning_rate,frequency=175*2,gamma=0.1):\n","            super(LRA, self).__init__()\n","            self.current_learning_rate=initial_learning_rate\n","            self.model=model\n","            self.frequency=frequency\n","            self.current_iter=0\n","            self.gamma=gamma\n","\n","        def on_train_begin(self, logs=None):\n","            tf.keras.backend.set_value(self.model.optimizer.lr,\n","                                       self.current_learning_rate)\n","\n","        def on_train_batch_end(self, batch, logs=None):\n","            self.current_iter+=1\n","            if self.current_iter%self.frequency==0:\n","                self.current_learning_rate=self.current_learning_rate-self.current_learning_rate*self.gamma\n","                tf.keras.backend.set_value(self.model.optimizer.lr, self.current_learning_rate)\n","                self.current_iter=0\n","                # print(\"Updating the learning rate to: \",self.current_learning_rate)\n","\n","    \n","    \n","    cb_list = [checkpoint_cb,\n","               tensorbard_cb,\n","               csvLogger_cb,\n","               LRA(model,lr,gamma=0.1),\n","               ]\n","\n","\n","\n","\n","\n","    # # Perform Training and Validation\n","    history = model.fit(\n","        train_dataset,\n","        steps_per_epoch=Ntrain // batch_size,\n","        epochs=N_EPOCHS,\n","        validation_data=val_dataset,\n","        validation_steps=Nval // batch_size,\n","        callbacks=cb_list\n","    )\n","    # Predictions on the testset\n","    print(\"Loading weights from \", checkpoint_cb.filepath)\n","    model.load_weights(checkpoint_cb.filepath)\n","    test_results = pd.DataFrame({'SBP_true': [],\n","                                 'DBP_true': [],\n","                                 'SBP_est': [],\n","                                 'DBP_est': []})\n","\n","    # store predictions on the test set as well as the corresponding ground truth in a csv file\n","    test_dataset = iter(test_dataset)\n","    for i in tqdm(range(int(Ntest // batch_size)), \"Running test\"):\n","        ppg_test, BP_true = test_dataset.next()\n","        BP_est = model.predict(ppg_test, verbose=0)\n","        with warnings.catch_warnings():\n","            TestBatchResult = pd.DataFrame({'SBP_true': BP_true[0].numpy(),\n","                                            'DBP_true': BP_true[1].numpy(),\n","                                            'SBP_est': np.squeeze(BP_est[0]),\n","                                            'DBP_est': np.squeeze(BP_est[1]),\n","                                            })\n","            test_results = test_results.append(TestBatchResult)\n","\n","    ResultsFile = join(ResultsDir, experiment_name + '_test_results.csv')\n","    test_results.to_csv(ResultsFile)\n","\n","    ResultsFileMae = join(ResultsDir, experiment_name + '_test_results_ae.csv')\n","\n","    sbp_mae = np.mean(np.abs(test_results[\"SBP_true\"] - test_results[\"SBP_est\"]))\n","    sbp_aestd = np.std(np.abs(test_results[\"SBP_true\"] - test_results[\"SBP_est\"]))\n","\n","    dbp_mae = np.mean(np.abs(test_results[\"DBP_true\"] - test_results[\"DBP_est\"]))\n","    dbp_aestd = np.std(np.abs(test_results[\"DBP_true\"] - test_results[\"DBP_est\"]))\n","\n","    with open(ResultsFileMae, \"w\") as output:\n","        writer = csv.writer(output)\n","        writer.writerow([\"sbp_mae\", \"sbp_aestd\", \"dbp_mae\", \"dbp_aestd\"])\n","        writer.writerow([sbp_mae, sbp_aestd, dbp_mae, dbp_aestd])\n","    test_results.to_csv(ResultsFile)\n","\n","    idx_min = np.argmin(history.history['val_loss'])\n","\n","    print(' Training finished')\n","\n","    return history.history['SBP_mae'][idx_min], history.history['DBP_mae'][idx_min], history.history['val_SBP_mae'][\n","        idx_min], history.history['val_DBP_mae'][idx_min]\n"]},{"cell_type":"markdown","id":"b75fc32c","metadata":{"papermill":{"duration":0.002817,"end_time":"2022-08-24T15:10:06.052731","exception":false,"start_time":"2022-08-24T15:10:06.049914","status":"completed"},"pycharm":{"name":"#%% md\n"},"tags":[]},"source":["# Launch training"]},{"cell_type":"code","execution_count":5,"id":"0e525a4e","metadata":{"collapsed":false,"execution":{"iopub.execute_input":"2022-08-24T15:10:06.060454Z","iopub.status.busy":"2022-08-24T15:10:06.059637Z","iopub.status.idle":"2022-08-24T16:48:19.791808Z","shell.execute_reply":"2022-08-24T16:48:19.790688Z"},"jupyter":{"outputs_hidden":false},"papermill":{"duration":5893.738535,"end_time":"2022-08-24T16:48:19.794217","exception":false,"start_time":"2022-08-24T15:10:06.055682","status":"completed"},"pycharm":{"name":"#%%\n"},"tags":[]},"outputs":[{"name":"stderr","output_type":"stream","text":["2022-08-24 15:10:06.076434: I tensorflow/core/platform/cpu_feature_guard.cc:142] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  AVX2 AVX512F FMA\n","To enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.\n","2022-08-24 15:10:06.076970: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:937] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero\n","2022-08-24 15:10:06.077944: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:937] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero\n","2022-08-24 15:10:06.078730: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:937] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero\n","2022-08-24 15:10:08.305057: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:937] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero\n","2022-08-24 15:10:08.305937: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:937] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero\n","2022-08-24 15:10:08.306603: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:937] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero\n","2022-08-24 15:10:08.307219: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1510] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 15403 MB memory:  -> device: 0, name: Tesla P100-PCIE-16GB, pci bus id: 0000:00:04.0, compute capability: 6.0\n","2022-08-24 15:10:10.110529: I tensorflow/core/profiler/lib/profiler_session.cc:131] Profiler session initializing.\n","2022-08-24 15:10:10.110580: I tensorflow/core/profiler/lib/profiler_session.cc:146] Profiler session started.\n","2022-08-24 15:10:10.112525: I tensorflow/core/profiler/internal/gpu/cupti_tracer.cc:1614] Profiler found 1 GPUs\n","2022-08-24 15:10:10.336910: I tensorflow/core/profiler/lib/profiler_session.cc:164] Profiler session tear down.\n","2022-08-24 15:10:10.337106: I tensorflow/core/profiler/internal/gpu/cupti_tracer.cc:1748] CUPTI activity buffer flushed\n"]},{"name":"stdout","output_type":"stream","text":["Epoch 1/20\n"]},{"name":"stderr","output_type":"stream","text":["2022-08-24 15:10:15.645395: I tensorflow/compiler/mlir/mlir_graph_optimization_pass.cc:185] None of the MLIR Optimization Passes are enabled (registered 2)\n","2022-08-24 15:10:22.049338: I tensorflow/stream_executor/cuda/cuda_dnn.cc:369] Loaded cuDNN version 8005\n"]},{"name":"stdout","output_type":"stream","text":["   1/1115 [..............................] - ETA: 5:34:21 - loss: 21310.5312 - SBP_loss: 16775.3027 - DBP_loss: 4535.2295 - SBP_mae: 127.2598 - SBP_mse: 16775.3027 - DBP_mae: 66.1305 - DBP_mse: 4535.2295"]},{"name":"stderr","output_type":"stream","text":["2022-08-24 15:10:28.767500: I tensorflow/core/profiler/lib/profiler_session.cc:131] Profiler session initializing.\n","2022-08-24 15:10:28.767559: I tensorflow/core/profiler/lib/profiler_session.cc:146] Profiler session started.\n"]},{"name":"stdout","output_type":"stream","text":["   2/1115 [..............................] - ETA: 17:06 - loss: 21215.2969 - SBP_loss: 17027.0938 - DBP_loss: 4188.2061 - SBP_mae: 128.1350 - SBP_mse: 17027.0938 - DBP_mae: 63.4639 - DBP_mse: 4188.2061  "]},{"name":"stderr","output_type":"stream","text":["2022-08-24 15:10:29.463214: I tensorflow/core/profiler/lib/profiler_session.cc:66] Profiler session collecting data.\n","2022-08-24 15:10:29.473524: I tensorflow/core/profiler/internal/gpu/cupti_tracer.cc:1748] CUPTI activity buffer flushed\n","2022-08-24 15:10:29.617549: I tensorflow/core/profiler/internal/gpu/cupti_collector.cc:673]  GpuTracer has collected 13427 callback api events and 13419 activity events. \n","2022-08-24 15:10:29.791344: I tensorflow/core/profiler/lib/profiler_session.cc:164] Profiler session tear down.\n","2022-08-24 15:10:30.085469: I tensorflow/core/profiler/rpc/client/save_profile.cc:136] Creating directory: /kaggle/working/logs/results/tb/2022-24-08_alexnet_training_kaggle/train/plugins/profile/2022_08_24_15_10_29\n","\n","2022-08-24 15:10:30.269996: I tensorflow/core/profiler/rpc/client/save_profile.cc:142] Dumped gzipped tool data for trace.json.gz to /kaggle/working/logs/results/tb/2022-24-08_alexnet_training_kaggle/train/plugins/profile/2022_08_24_15_10_29/2ce512458e80.trace.json.gz\n","2022-08-24 15:10:30.473892: I tensorflow/core/profiler/rpc/client/save_profile.cc:136] Creating directory: /kaggle/working/logs/results/tb/2022-24-08_alexnet_training_kaggle/train/plugins/profile/2022_08_24_15_10_29\n","\n","2022-08-24 15:10:30.484018: I tensorflow/core/profiler/rpc/client/save_profile.cc:142] Dumped gzipped tool data for memory_profile.json.gz to /kaggle/working/logs/results/tb/2022-24-08_alexnet_training_kaggle/train/plugins/profile/2022_08_24_15_10_29/2ce512458e80.memory_profile.json.gz\n","2022-08-24 15:10:30.488857: I tensorflow/core/profiler/rpc/client/capture_profile.cc:251] Creating directory: /kaggle/working/logs/results/tb/2022-24-08_alexnet_training_kaggle/train/plugins/profile/2022_08_24_15_10_29\n","Dumped tool data for xplane.pb to /kaggle/working/logs/results/tb/2022-24-08_alexnet_training_kaggle/train/plugins/profile/2022_08_24_15_10_29/2ce512458e80.xplane.pb\n","Dumped tool data for overview_page.pb to /kaggle/working/logs/results/tb/2022-24-08_alexnet_training_kaggle/train/plugins/profile/2022_08_24_15_10_29/2ce512458e80.overview_page.pb\n","Dumped tool data for input_pipeline.pb to /kaggle/working/logs/results/tb/2022-24-08_alexnet_training_kaggle/train/plugins/profile/2022_08_24_15_10_29/2ce512458e80.input_pipeline.pb\n","Dumped tool data for tensorflow_stats.pb to /kaggle/working/logs/results/tb/2022-24-08_alexnet_training_kaggle/train/plugins/profile/2022_08_24_15_10_29/2ce512458e80.tensorflow_stats.pb\n","Dumped tool data for kernel_stats.pb to /kaggle/working/logs/results/tb/2022-24-08_alexnet_training_kaggle/train/plugins/profile/2022_08_24_15_10_29/2ce512458e80.kernel_stats.pb\n","\n"]},{"name":"stdout","output_type":"stream","text":["1115/1115 [==============================] - 311s 263ms/step - loss: 918.0692 - SBP_loss: 650.8228 - DBP_loss: 267.2478 - SBP_mae: 19.7305 - SBP_mse: 650.8228 - DBP_mae: 12.0575 - DBP_mse: 267.2478 - val_loss: 307.1528 - val_SBP_loss: 269.6182 - val_DBP_loss: 37.5336 - val_SBP_mae: 14.2647 - val_SBP_mse: 269.6182 - val_DBP_mae: 5.6573 - val_DBP_mse: 37.5336\n","Epoch 2/20\n","1115/1115 [==============================] - 290s 260ms/step - loss: 670.1755 - SBP_loss: 508.6120 - DBP_loss: 161.5637 - SBP_mae: 17.9761 - SBP_mse: 508.6120 - DBP_mae: 9.2877 - DBP_mse: 161.5637 - val_loss: 449.3828 - val_SBP_loss: 400.2423 - val_DBP_loss: 49.1396 - val_SBP_mae: 17.0683 - val_SBP_mse: 400.2423 - val_DBP_mae: 5.8178 - val_DBP_mse: 49.1396\n","Epoch 3/20\n","1115/1115 [==============================] - 290s 261ms/step - loss: 646.7571 - SBP_loss: 489.6740 - DBP_loss: 157.0824 - SBP_mae: 17.5897 - SBP_mse: 489.6740 - DBP_mae: 9.0722 - DBP_mse: 157.0824 - val_loss: 336.6538 - val_SBP_loss: 290.6377 - val_DBP_loss: 46.0159 - val_SBP_mae: 14.4119 - val_SBP_mse: 290.6377 - val_DBP_mae: 6.0589 - val_DBP_mse: 46.0159\n","Epoch 4/20\n","1115/1115 [==============================] - 290s 260ms/step - loss: 643.2437 - SBP_loss: 485.8503 - DBP_loss: 157.3942 - SBP_mae: 17.5190 - SBP_mse: 485.8503 - DBP_mae: 9.0572 - DBP_mse: 157.3942 - val_loss: 370.4246 - val_SBP_loss: 335.6328 - val_DBP_loss: 34.7925 - val_SBP_mae: 14.7029 - val_SBP_mse: 335.6328 - val_DBP_mae: 5.3378 - val_DBP_mse: 34.7925\n","Epoch 5/20\n","1115/1115 [==============================] - 291s 261ms/step - loss: 623.5533 - SBP_loss: 468.5481 - DBP_loss: 155.0054 - SBP_mae: 17.1713 - SBP_mse: 468.5481 - DBP_mae: 8.9786 - DBP_mse: 155.0054 - val_loss: 402.0385 - val_SBP_loss: 373.0150 - val_DBP_loss: 29.0234 - val_SBP_mae: 14.8406 - val_SBP_mse: 373.0150 - val_DBP_mae: 4.8044 - val_DBP_mse: 29.0234\n","Epoch 6/20\n","1115/1115 [==============================] - 290s 260ms/step - loss: 618.6273 - SBP_loss: 465.2922 - DBP_loss: 153.3347 - SBP_mae: 17.0784 - SBP_mse: 465.2922 - DBP_mae: 8.9206 - DBP_mse: 153.3347 - val_loss: 353.9581 - val_SBP_loss: 324.6713 - val_DBP_loss: 29.2868 - val_SBP_mae: 14.2033 - val_SBP_mse: 324.6713 - val_DBP_mae: 4.1750 - val_DBP_mse: 29.2868\n","Epoch 7/20\n","1115/1115 [==============================] - 291s 261ms/step - loss: 609.2439 - SBP_loss: 457.0331 - DBP_loss: 152.2109 - SBP_mae: 16.9022 - SBP_mse: 457.0331 - DBP_mae: 8.8590 - DBP_mse: 152.2109 - val_loss: 310.7137 - val_SBP_loss: 270.3400 - val_DBP_loss: 40.3731 - val_SBP_mae: 12.7741 - val_SBP_mse: 270.3400 - val_DBP_mae: 4.5885 - val_DBP_mse: 40.3731\n","Epoch 8/20\n","1115/1115 [==============================] - 296s 266ms/step - loss: 602.3839 - SBP_loss: 450.8687 - DBP_loss: 151.5156 - SBP_mae: 16.7837 - SBP_mse: 450.8687 - DBP_mae: 8.8527 - DBP_mse: 151.5156 - val_loss: 438.6873 - val_SBP_loss: 402.4689 - val_DBP_loss: 36.2169 - val_SBP_mae: 16.1932 - val_SBP_mse: 402.4689 - val_DBP_mae: 5.4081 - val_DBP_mse: 36.2169\n","Epoch 9/20\n","1115/1115 [==============================] - 291s 261ms/step - loss: 597.8994 - SBP_loss: 448.0904 - DBP_loss: 149.8092 - SBP_mae: 16.7130 - SBP_mse: 448.0904 - DBP_mae: 8.8091 - DBP_mse: 149.8092 - val_loss: 329.1635 - val_SBP_loss: 292.0712 - val_DBP_loss: 37.0908 - val_SBP_mae: 13.6715 - val_SBP_mse: 292.0712 - val_DBP_mae: 5.0181 - val_DBP_mse: 37.0908\n","Epoch 10/20\n","1115/1115 [==============================] - 290s 260ms/step - loss: 597.4017 - SBP_loss: 445.7208 - DBP_loss: 151.6812 - SBP_mae: 16.6581 - SBP_mse: 445.7208 - DBP_mae: 8.8407 - DBP_mse: 151.6812 - val_loss: 327.8828 - val_SBP_loss: 290.5738 - val_DBP_loss: 37.3092 - val_SBP_mae: 13.8208 - val_SBP_mse: 290.5738 - val_DBP_mae: 4.9174 - val_DBP_mse: 37.3092\n","Epoch 11/20\n","1115/1115 [==============================] - 290s 260ms/step - loss: 591.3344 - SBP_loss: 440.4106 - DBP_loss: 150.9235 - SBP_mae: 16.5671 - SBP_mse: 440.4106 - DBP_mae: 8.8082 - DBP_mse: 150.9235 - val_loss: 320.1486 - val_SBP_loss: 289.1587 - val_DBP_loss: 30.9908 - val_SBP_mae: 13.8325 - val_SBP_mse: 289.1587 - val_DBP_mae: 4.5555 - val_DBP_mse: 30.9908\n","Epoch 12/20\n","1115/1115 [==============================] - 290s 261ms/step - loss: 591.1939 - SBP_loss: 441.5332 - DBP_loss: 149.6604 - SBP_mae: 16.5647 - SBP_mse: 441.5332 - DBP_mae: 8.7817 - DBP_mse: 149.6604 - val_loss: 351.0421 - val_SBP_loss: 321.6400 - val_DBP_loss: 29.4034 - val_SBP_mae: 14.7722 - val_SBP_mse: 321.6400 - val_DBP_mae: 4.4641 - val_DBP_mse: 29.4034\n","Epoch 13/20\n","1115/1115 [==============================] - 290s 260ms/step - loss: 587.5056 - SBP_loss: 437.2128 - DBP_loss: 150.2929 - SBP_mae: 16.5054 - SBP_mse: 437.2128 - DBP_mae: 8.7829 - DBP_mse: 150.2929 - val_loss: 288.7509 - val_SBP_loss: 255.8396 - val_DBP_loss: 32.9122 - val_SBP_mae: 12.9402 - val_SBP_mse: 255.8396 - val_DBP_mae: 4.7179 - val_DBP_mse: 32.9122\n","Epoch 14/20\n","1115/1115 [==============================] - 290s 260ms/step - loss: 585.2460 - SBP_loss: 436.6038 - DBP_loss: 148.6417 - SBP_mae: 16.5087 - SBP_mse: 436.6038 - DBP_mae: 8.7732 - DBP_mse: 148.6417 - val_loss: 292.3196 - val_SBP_loss: 258.1833 - val_DBP_loss: 34.1363 - val_SBP_mae: 12.8645 - val_SBP_mse: 258.1833 - val_DBP_mae: 4.6466 - val_DBP_mse: 34.1363\n","Epoch 15/20\n","1115/1115 [==============================] - 290s 261ms/step - loss: 580.1207 - SBP_loss: 431.4670 - DBP_loss: 148.6536 - SBP_mae: 16.3846 - SBP_mse: 431.4670 - DBP_mae: 8.7439 - DBP_mse: 148.6536 - val_loss: 283.3791 - val_SBP_loss: 248.2040 - val_DBP_loss: 35.1752 - val_SBP_mae: 12.8743 - val_SBP_mse: 248.2040 - val_DBP_mae: 4.6228 - val_DBP_mse: 35.1752\n","Epoch 16/20\n","1115/1115 [==============================] - 292s 262ms/step - loss: 581.8378 - SBP_loss: 431.6964 - DBP_loss: 150.1416 - SBP_mae: 16.3903 - SBP_mse: 431.6964 - DBP_mae: 8.7836 - DBP_mse: 150.1416 - val_loss: 294.1945 - val_SBP_loss: 260.6885 - val_DBP_loss: 33.5045 - val_SBP_mae: 13.3768 - val_SBP_mse: 260.6885 - val_DBP_mae: 4.6508 - val_DBP_mse: 33.5045\n","Epoch 17/20\n","1115/1115 [==============================] - 290s 260ms/step - loss: 583.6907 - SBP_loss: 434.8046 - DBP_loss: 148.8858 - SBP_mae: 16.4237 - SBP_mse: 434.8046 - DBP_mae: 8.7617 - DBP_mse: 148.8858 - val_loss: 297.4681 - val_SBP_loss: 264.5242 - val_DBP_loss: 32.9430 - val_SBP_mae: 13.5828 - val_SBP_mse: 264.5242 - val_DBP_mae: 4.6922 - val_DBP_mse: 32.9430\n","Epoch 18/20\n","1115/1115 [==============================] - 291s 261ms/step - loss: 580.4438 - SBP_loss: 432.5474 - DBP_loss: 147.8961 - SBP_mae: 16.4323 - SBP_mse: 432.5474 - DBP_mae: 8.7428 - DBP_mse: 147.8961 - val_loss: 280.4335 - val_SBP_loss: 246.4542 - val_DBP_loss: 33.9786 - val_SBP_mae: 13.1174 - val_SBP_mse: 246.4542 - val_DBP_mae: 4.7299 - val_DBP_mse: 33.9786\n","Epoch 19/20\n","1115/1115 [==============================] - 291s 261ms/step - loss: 581.8746 - SBP_loss: 432.5754 - DBP_loss: 149.2992 - SBP_mae: 16.3980 - SBP_mse: 432.5754 - DBP_mae: 8.7744 - DBP_mse: 149.2992 - val_loss: 305.8933 - val_SBP_loss: 275.3584 - val_DBP_loss: 30.5353 - val_SBP_mae: 13.5334 - val_SBP_mse: 275.3584 - val_DBP_mae: 4.3477 - val_DBP_mse: 30.5353\n","Epoch 20/20\n","1115/1115 [==============================] - 290s 260ms/step - loss: 586.5789 - SBP_loss: 435.6555 - DBP_loss: 150.9236 - SBP_mae: 16.4647 - SBP_mse: 435.6555 - DBP_mae: 8.7943 - DBP_mse: 150.9236 - val_loss: 292.3074 - val_SBP_loss: 260.5672 - val_DBP_loss: 31.7393 - val_SBP_mae: 13.3030 - val_SBP_mse: 260.5672 - val_DBP_mae: 4.4977 - val_DBP_mse: 31.7393\n","Loading weights from  /kaggle/working/logs/checkpoints/2022-24-08_alexnet_training_kaggle_cb.h5\n"]},{"name":"stderr","output_type":"stream","text":["Running test: 100%|██████████| 239/239 [00:41<00:00,  5.81it/s]\n"]},{"name":"stdout","output_type":"stream","text":[" Training finished\n"]},{"data":{"text/plain":["(16.43231964111328, 8.742803573608398, 13.117436408996582, 4.729869842529297)"]},"execution_count":5,"metadata":{},"output_type":"execute_result"}],"source":["architecture = \"alexnet\"\n","experiment_name = \"training_kaggle\"\n","experiment_name = datetime.now().strftime(\"%Y-%d-%m\") + '_' + architecture + '_' + experiment_name\n","# experiment_name=\"2022-08-08_alexnet_training4\"\n","ROOT_DIR=\"/kaggle/working/logs\"\n","DataDir = \"/kaggle//input/mmicadatasetwin/train_test_from_mat\"\n","ResultsDir = os.path.join(ROOT_DIR, \"results\")\n","CheckpointDir = os.path.join(ROOT_DIR,\"checkpoints\")\n","tb_tag = experiment_name\n","lr = 0.001\n","batch_size = 32\n","WIN_LEN = 700\n","N_EPOCHS = 20\n","\n","\n","tfrecord_basename = 'MIMIC_III_ppg'\n","\n","ppg_train_mimic_iii(architecture,\n","                    DataDir,\n","                    ResultsDir,\n","                    CheckpointDir,\n","                    tb_tag,\n","                    tfrecord_basename,\n","                    experiment_name,\n","                    win_len=WIN_LEN,\n","                    batch_size=batch_size,\n","                    lr=lr,\n","                    N_epochs=N_EPOCHS,\n","                    UseDerivative=True,\n","                    earlystopping=False)  # False originally\n"]},{"cell_type":"code","execution_count":null,"id":"94c33cef","metadata":{"papermill":{"duration":1.269796,"end_time":"2022-08-24T16:48:22.410718","exception":false,"start_time":"2022-08-24T16:48:21.140922","status":"completed"},"tags":[]},"outputs":[],"source":[]},{"cell_type":"code","execution_count":null,"id":"6a97c04f","metadata":{"papermill":{"duration":1.495821,"end_time":"2022-08-24T16:48:25.229053","exception":false,"start_time":"2022-08-24T16:48:23.733232","status":"completed"},"tags":[]},"outputs":[],"source":[]}],"metadata":{"kernelspec":{"display_name":"Python 3","language":"python","name":"python3"},"language_info":{"codemirror_mode":{"name":"ipython","version":3},"file_extension":".py","mimetype":"text/x-python","name":"python","nbconvert_exporter":"python","pygments_lexer":"ipython3","version":"3.7.12"},"papermill":{"default_parameters":{},"duration":5917.581049,"end_time":"2022-08-24T16:48:29.418711","environment_variables":{},"exception":null,"input_path":"__notebook__.ipynb","output_path":"__notebook__.ipynb","parameters":{},"start_time":"2022-08-24T15:09:51.837662","version":"2.3.4"}},"nbformat":4,"nbformat_minor":5}